{% extends "base.html" %}

{% block title %}Upload - Age-Normed MRIQC{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="bi bi-cloud-upload"></i>
                    Upload MRIQC Data
                </h4>
            </div>
            <div class="card-body">
                <div class="upload-area" id="upload-area">
                    <div class="upload-content text-center py-5">
                        <i class="bi bi-cloud-upload display-1 text-muted mb-3"></i>
                        <h5>Drag and drop your MRIQC CSV file here</h5>
                        <p class="text-muted">or click to browse files</p>
                        <input type="file" id="file-input" class="d-none" accept=".csv">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('file-input').click()">
                            <i class="bi bi-folder2-open"></i>
                            Browse Files
                        </button>
                    </div>
                </div>
                
                <!-- File Information -->
                <div id="file-info" class="mt-4 d-none">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">
                                <i class="bi bi-file-earmark-text"></i>
                                File Information
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Filename:</strong> <span id="file-name"></span></p>
                                    <p class="mb-1"><strong>Size:</strong> <span id="file-size"></span></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Subjects:</strong> <span id="subjects-count"></span></p>
                                    <p class="mb-1"><strong>Status:</strong> <span id="file-status" class="badge bg-secondary">Ready</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Processing Options -->
                <div id="processing-options" class="mt-4 d-none">
                    <h6>Processing Options</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="apply-quality-assessment" checked>
                                <label class="form-check-label" for="apply-quality-assessment">
                                    Apply Quality Assessment
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="use-age-normalization" checked>
                                <label class="form-check-label" for="use-age-normalization">
                                    Use Age-Specific Normalization
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="generate-reports">
                                <label class="form-check-label" for="generate-reports">
                                    Generate Quality Reports
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="send-notifications">
                                <label class="form-check-label" for="send-notifications">
                                    Send Processing Notifications
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="mt-4 d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" id="clear-file" disabled>
                        <i class="bi bi-x-circle"></i>
                        Clear File
                    </button>
                    <button type="button" class="btn btn-primary" id="process-file" disabled>
                        <i class="bi bi-play-circle"></i>
                        Process File
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Processing Progress -->
        <div id="processing-progress" class="card mt-4 d-none">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i>
                    Processing Status
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>Progress</span>
                        <span id="progress-percentage">0%</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6 class="text-muted">Processed</h6>
                            <h4 id="processed-count">0</h4>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6 class="text-muted">Total</h6>
                            <h4 id="total-count">0</h4>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <h6 class="text-muted">Errors</h6>
                            <h4 id="error-count" class="text-danger">0</h4>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Current Status</h6>
                    <div id="current-status" class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        Ready to start processing...
                    </div>
                </div>
                
                <!-- Processing Log -->
                <div class="mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6>Processing Log</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="toggleProcessingLog()">
                            <i class="bi bi-chevron-down" id="log-toggle-icon"></i>
                            <span id="log-toggle-text">Show Details</span>
                        </button>
                    </div>
                    <div id="processing-log" class="mt-2 d-none">
                        <div class="bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.875rem;">
                            <div id="log-content">
                                <div class="text-muted">Processing log will appear here...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="mt-3 d-flex justify-content-between">
                    <button type="button" class="btn btn-outline-danger" id="cancel-processing" disabled>
                        <i class="bi bi-stop-circle"></i>
                        Cancel Processing
                    </button>
                    <div>
                        <button type="button" class="btn btn-outline-primary" id="view-results" disabled>
                            <i class="bi bi-eye"></i>
                            View Results
                        </button>
                        <button type="button" class="btn btn-success" id="go-to-dashboard" disabled>
                            <i class="bi bi-speedometer2"></i>
                            Go to Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Upload History -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history"></i>
                    Recent Uploads
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Subjects</th>
                                <th>Status</th>
                                <th>Uploaded</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="upload-history-tbody">
                            <tr>
                                <td colspan="5" class="text-center text-muted py-3">
                                    <i class="bi bi-inbox"></i>
                                    No recent uploads
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- File Validation Modal -->
<div class="modal fade" id="validation-modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">File Validation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="validation-content">
                    <div class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Validating...</span>
                        </div>
                        <p class="mt-2">Validating file format...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/upload.js"></script>
{% endblock %}